<!DOCTYPE HTML>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="zh-CN" lang="zh-CN">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>phpcmsV9列表页添加文章所属栏目及点击数</title>
        <link media="all" rel="stylesheet" href="../css/reset.css" type="text/css" />
        <link type="text/css" rel="stylesheet" href="../css/text.css" />
        <link rel="stylesheet" href="../css/viki.css">
        
    </head>
    <body>
    <!-- 固定头部 -->
        <iframe src="../header.html" frameborder="0" width="100%" height="55px"></iframe>
    <!-- 内容开始 -->
        <div class="main w1220">
            <br>
            <center style="font-family: 'Microsoft Yahei', sans-serif; font-size: 1.80em; 
                font-weight: normal; color: #FF6600">phpcmsV9列表页添加文章所属栏目及点击数</center>
            <!-- 知识点 -->
            <h3>1、二次开发</h3>
<p>phpcms默认首页是无法调用出文章的点击数，而调用文章所属的栏目名称也很复杂，需要先使用php语句进行数据缓存后才能调用。其实我们可以一步到位，自己添加函数来实现在首页/频道页/列表页调用文章点击数及文章所属栏目名称</p>

<p>实现效果步骤如下：</p>
<ul>
    <li>①打开<code>\phpcms\modules\content\classes\content_tag.class.php</code>文件；</li>
    <li>②搜索“<code>列表页标签</code>”，即lists标签函数，应该在文件的56行左右，把lists标签函数的整段调用代码修改如下：</li>
    <li><xmp>/** 
* 列表页标签 
* @param $data 
*/
publicfunction lists($data) { 
$catid = intval($data['catid']); 
if(!$this->set_modelid($catid)) return false; 
if(isset($data['where'])) { 
$sql = $data['where']; 
} else { 
$thumb = intval($data['thumb']) ? " AND thumb != ''" : ''; 
if($this->category[$catid]['child']) { 
$catids_str = $this->category[$catid]['arrchildid']; 
$pos = strpos($catids_str,',')+1; 
$catids_str = substr($catids_str, $pos); 
$sql = "status=99 AND catid IN ($catids_str)".$thumb; 
} else { 
$sql = "status=99 AND catid='$catid'".$thumb; 
} 
} 
$order = $data['order']; 
$return = $this->db->select($sql, '*', $data['limit'], $order, '', 'id'); 
//二次开发============================================= 
foreach($returnas &$r){ 
$h_md=pc_base::load_model('hits_model'); 
$get_db=$h_md->get_one(array('hitsid'=>"c-".$this->db->modelid."-".$r[id])); 
$r['views']=$get_db[views]; 
$c_md=pc_base::load_model('category_model'); 
$c_data = $c_md->get_one(array('catid'=>$r[catid])); 
$r['catname']=$c_data[catname]; //栏目名称
$r['caturl']=$c_data[url]; //栏目地址
} 
//原文无此段落 原因：列表获得浏览次数============================================= 
/* 2013年4月 
*使用方法 
* {loop $data $r} 
* {$r[caturl]}-{$r[catname]}-{$r[title]}-{$r[views]} 
* {/loop} 
*/
//调用副表的数据 
if (isset($data['moreinfo']) && intval($data['moreinfo']) == 1) { 
$ids = array(); 
foreach ($returnas$v) { 
if (isset($v['id']) && !emptyempty($v['id'])) { 
$ids[] = $v['id']; 
} else { 
continue; 
} 
} 
if (!emptyempty($ids)) { 
$this->db->table_name = $this->db->table_name.'_data'; 
$ids = implode('\',\'', $ids); 
$r = $this->db->select("`id` IN ('$ids')", '*', '', '', '', 'id'); 
if (!emptyempty($r)) { 
foreach ($ras$k=>$v) { 
if (isset($return[$k])) $return[$k] = array_merge($v, $return[$k]); 
} 
} 
} 
} 
return$return; 
} 
</xmp></li>
</ul>

<p>上面的函数代码里已经标注了新添加标签的函数代码，即23行至38行；</p>

<h3>2、调用方法</h3>
<p>前端页面模板调用代码的方法（示例）已经在上述函数代码里标明，我再重新说一下：</p>
<p>在文章列表页模板中修改文章列表标签为：</p>
<xmp>{loop $data$r}
{$r[catname]}-{$r[title]}-{$r[views]}
{/loop}</xmp>

        </div>
        <div id="ft">
            <div id="footer" class="w1220 cl">
                <hr>
                <center style="font-family: 微软雅黑; font-size: small; font-weight: normal; color: #009933">
                        edited by cq&nbsp;©&nbsp;2011-2015&nbsp;1457063@qq.com
                        <br>
                        Generated by <a href="#" target="_blank">sublime</a> 
            </div>
        </div>
    </body>
</html>
